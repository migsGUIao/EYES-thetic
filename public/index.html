<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>EYES-thetic 24:7</title>
        <style>
            /* Optional styling for clarity */
            #recommendation-container {
            margin-top: 20px;
            }
            .recommendation-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            }
            .recommendation-box img {
            width: 150px;
            height: auto;
            }
        </style>
    </head>
    <body>
    <h2>EYES-thetic 24/7 user input</h1>
    <p>Select your clothing preference!</p>

    <form id="recommendForm">
        <label for ="gender">Choose gender: </label>
        <select id ="gender" name="gender">
            <option value="Men">Men</option>
            <option value="Women">Women</option>
        </select>
        <br>

        <label for ="season">Choose season: </label>
        <select id ="season" name="season">
            <option value="Fall">Fall</option>
            <option value="Summer">Summer</option>
            <option value="Winter">Winter</option>
            <option value="Spring">Spring</option>
        </select>
        <br>

        <label for="usage">Choose usage: </label>
        <select id="usage" name="usage">
            <option value="Casual">Casual</option>
            <option value="Formal">Formal</option>
            <option value="Sports">Sports</option>
        </select>
        <br>

        <button type="button" onclick="submitForm()">Get Recommendations</button>
    </form>
    
    <h3>Recommendations:</h3>
    <div id="recommendation-container">
        <div id="recommendation"></div>
        <button id="nextRecommendation" onclick="showNextRecommendation()" style="display: none;">Next Recommendation</button>
    </div>

    <script>
        // Global variables to store recommendations and track the current index
        let recommendations = [];
        let currentIndex = 0;

        async function submitForm() {
            const form = document.getElementById('recommendForm');

            // collect form data
            const data = {
                gender: form.gender.value,
                season: form.season.value,
                usage: form.usage.value
            };

            try {
                // Send data to the backend
                const response = await fetch('/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // Parse and display the response
                const result = await response.json();

                // Check if any recommendations were returned
                if (result.message) {
                    document.getElementById('recommendation').innerHTML = `<p>${result.message}</p>`;
                    return;
                }

                // Save the recommendations and reset the current index
                recommendations = result;
                currentIndex = 0;

                // Display the first recommendation
                showNextRecommendation();
            } catch (error) {
                console.error('Error fetching recommendations:', error);
                document.getElementById('recommendation').innerHTML = `<p>Error fetching recommendations. Please try again later.</p>`;
            }
        }

        function showNextRecommendation() {
            // Interrupt ongoing speech to make way for new ones
            window.speechSynthesis.cancel();

            // If there are no more recommendations, display a message
            if (currentIndex >= recommendations.length) {
                document.getElementById('recommendation').innerHTML = "<p>No more recommendations available.</p>";
                document.getElementById('nextRecommendation').style.display = 'none';
                return;
            }

            // Retrieve the current recommendation from the array
            const rec = recommendations[currentIndex];

            // HTML content for the current recommendation
            const html = `
                <div class="recommendation-box">
                <h4>Topwear</h4>
                ${rec.top_image ? `<img src="${rec.top_image}" alt="${rec.top_name}" />` : '<p>No Image Available</p>'}
                <p><b>Top:</b> ${rec.top_name} (${rec.top_colour})</p>

                <h4>Bottomwear</h4>
                ${rec.bottom_image ? `<img src="${rec.bottom_image}" alt="${rec.bottom_name}" />` : '<p>No Image Available</p>'}
                <p><b>Bottom:</b> ${rec.bottom_name} (${rec.bottom_colour})</p>
                
                <p><b>Gender:<b> ${rec.gender}</p>
                <p><b>Season:</b> ${rec.season}</p>
                <p><b>Usage:</b> ${rec.usage}</p>
                </div>
            `;
            document.getElementById('recommendation').innerHTML = html;

            // Use the SpeechSynthesis API for TTS
            const description = `Recommended outfit. Top: ${rec.top_name}. Bottom: ${rec.bottom_name}.`;
            speakText(description);

            document.getElementById('nextRecommendation').style.display =
                (currentIndex < recommendations.length - 1) ? 'block' : 'none';

            // Move to the next recommendation
            currentIndex++;
        }

        function speakText(text) {
            // TTS
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';  

            utterance.volume = 1;
            utterance.rate = 1;
            utterance.pitch = 1;

            window.speechSynthesis.speak(utterance);
        }
    </script>
    </body>
</html>